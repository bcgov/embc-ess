<form novalidate (ngSubmit)="onSubmit()" [formGroup]="form">
  <h2 class="step">STEP 1 of 4</h2>
  <h1 class="mt-3">Register as an Evacuee</h1>

  <p>If you have been given an evacuation order and have been asked to leave your home, use this step-by-step Evacuee
    Self-Registration form to register with Emergency Support Services.</p>

  <small>All required fields are marked with an asterisk *</small>

  <div class="mt-3 feature-block">
    <h3 class="required">Restriction</h3>
    <p>Concerned family and friends may inquire about you and your family because of the emergency. We would like to
      provide these people with some information about you. May we disclose your location and the contact information
      for you and your family members?
    </p>
    <div class="form-check">
      <input class="form-check-input" type="radio" [value]="false" formControlName="restrictedAccess" (click)="setRestricted(false)">
      <label class="form-check-label" for="exampleRadios1">
        <strong>Yes</strong>
      </label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" [value]="true" formControlName="restrictedAccess" (click)="setRestricted(true)">
      <label class="form-check-label" for="exampleRadios2">
        <strong>No</strong> - (Please proceed to the nearest open pilot community Emergency Support Services reception
        centre to initiate your registration and receive supports.)
      </label>
    </div>
  </div>
  <div *ngIf="disableForm===true">
    <h3 class="blue-header">PROCEED TO RECEPTION CENTRE</h3>
    <h4 class="font-weight-bold mt-5">Your data privacy is important to us.</h4>
    <p>
      During an emergency response many people join the response effort. We want to ensure that your information remains
      unseen except by people that are trained to handle sensitive information.
    </p>
    <p>
      Please proceed to the nearest open pilot community Emergency Support Services reception centre to initiate your
      registration and receive supports.
    </p>
    <p>
      Your nearest Reception Centre is listed at <a target="_blank" href="https://www.emergencyinfobc.gov.bc.ca/">EmergencyInfoBC</a>
    </p>
  </div>
  <div *ngIf="disableForm===false">
    <h3 class="blue-header">EVACUEE DETAILS</h3>
    <section class="padded-section" formGroupName="headOfHousehold">
      <div class="row">
        <app-form-field class="col-md-9" required="true" tooltip="Tool Tip: Please ensure you use the legal last name of the person registering the family.">
          <label>Last Name</label>
          <input [class.is-invalid]="invalid('headOfHousehold.lastName')" class="form-control" type="text" formControlName="lastName">
          <span *ngIf="submitted" class="invalid-feedback">
            {{validationErrors['headOfHousehold'].lastName}}
          </span>
        </app-form-field>
      </div>
      <div class="row">
        <app-form-field class="col-md-9" required="true" tooltip="Tool Tip: Please ensure you use the legal first name of the person registering the family.">
          <label>First Name</label>
          <input [class.is-invalid]="invalid('headOfHousehold.firstName')" class="form-control" type="text" formControlName="firstName">
          <span *ngIf="submitted" class="invalid-feedback">
            {{validationErrors['headOfHousehold'].firstName}}
          </span>
        </app-form-field>
      </div>
      <div class="row">
        <app-form-field class="col-md-2">
          <label>Initial</label>
          <input class="form-control" type="text" formControlName="initials">
        </app-form-field>
        <app-form-field class="col-md-7">
          <label>Preferred Name</label>
          <input class="form-control" type="text" formControlName="nickname">
        </app-form-field>
      </div>
      <div class="row">
        <app-form-field class="col-md-4">
          <label>Gender</label>
          <select class="form-control" formControlName="gender">
            <option [ngValue]="null">Please select--</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="x">X</option>
          </select>
        </app-form-field>
        <div class="col-md-4">
          <!-- TODO: Split DOB into 3 inputs [MM] [DD] [YYYY] -->
          <label class="required">Date of Birth</label>
          <input type="text" placeholder="yyyy-mm-dd" [class.is-invalid]="invalid('headOfHousehold.dob')" class="form-control" formControlName="dob">
          <small>(Format: yyyy-mm-dd)</small>
          <span *ngIf="submitted" class="invalid-feedback">
            {{validationErrors['headOfHousehold'].dob}}
          </span>
        </div>
      </div>
    </section>

    <h3 class="blue-header">EVACUEE FAMILY INFORMATION
      <!-- TODO: Implement animation for info circle on-hover -->
      <app-font-awesome-icon icon="info-circle" className="ml-3 text-white" title="Each additional immediate family member needs to be added to your Evacuee Registration if they reside in the same household as you. Roommates or tenants of the same address need to be registered separately.">
      </app-font-awesome-icon>
    </h3>
    <section class="padded-section">
      <p class="required">Are you registering immediate family members who live in the same household with you?</p>
      <div class="form-group">
        <div class="form-check">
          <input [class.is-invalid]="invalid('registeringFamilyMembers')" class="form-check-input" type="radio" value="yes" formControlName="registeringFamilyMembers">
          <label class="form-check-label">Yes</label>
        </div>
        <div class="form-check">
          <input [class.is-invalid]="invalid('registeringFamilyMembers')" class="form-check-input" type="radio" value="yes-later" formControlName="registeringFamilyMembers">
          <label class="form-check-label">Yes, but I'd like to register them when I get to the
            Reception Center</label>
        </div>
        <div class="form-check">
          <input [class.is-invalid]="invalid('registeringFamilyMembers')" class="form-check-input" type="radio" value="no" formControlName="registeringFamilyMembers">
          <label class="form-check-label">No</label>
          <span *ngIf="submitted" class="invalid-feedback">
            {{validationErrors['registeringFamilyMembers']}}
          </span>
        </div>
      </div>
      <div *ngIf="ui.showFamilyMembers()">
        <div class="family-members__list" formArrayName="familyMembers">
          <div class="feature-block card p-0 mb-2" *ngFor="let entry of familyMembers.controls; index as i;" [formGroupName]="i">
            <!-- TODO: Refactor into sub-component -->
            <div class="card-body">
              <div class="row mb-2">
                <div class="col">
                  <label class="required">Last Name</label>
                  <input [class.is-invalid]="invalid('lastName', entry)" class="form-control" type="text" formControlName="lastName">
                  <span *ngIf="submitted" class="invalid-feedback">Please enter a last name.</span>
                </div>
                <!-- <div class="col">
                  <label>
                    Same as main applicant.
                  </label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" [value]="true"
                      formControlName="sameLastNameAsEvacuee">
                  </div>
                </div> -->
              </div>
              <div class="row mb-2">
                <div class="col">
                  <label class="required">First Name</label>
                  <input [class.is-invalid]="invalid('firstName', entry)" class="form-control" type="text" formControlName="firstName">
                  <span *ngIf="submitted" class="invalid-feedback">Please enter a first name.</span>
                </div>
                <div class="col">
                  <label>Initial</label>
                  <input type="text" class="form-control" formControlName="initials">
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-6">
                  <label class="required">Relationship to evacuee</label>
                  <select [class.is-invalid]="invalid('relationshipToEvacuee', entry)" class="form-control" formControlName="relationshipToEvacuee">
                    <option [ngValue]="null">Please select--</option>
                    <option [ngValue]="item" *ngFor="let item of relationshipTypes$ | async">
                      {{item.description}}
                    </option>
                  </select>
                  <span *ngIf="submitted" class="invalid-feedback">
                    Please state your relationship to this family member.
                  </span>
                </div>
                <div class="col">
                  <label>Gender</label>
                  <select class="form-control" formControlName="gender">
                    <option [ngValue]="null">Please select--</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="x">X</option>
                  </select>
                </div>
                <div class="col">
                  <label class="required">Date of Birth</label>
                  <input type="text" placeholder="yyyy-mm-dd" [class.is-invalid]="invalid('dob', entry)" class="form-control" formControlName="dob">
                  <small>(Format: yyyy-mm-dd)</small>
                  <span *ngIf="submitted && hasErrors('dob', entry, ['required'])" class="invalid-feedback">
                    Please enter a date of birth.
                  </span>
                  <ng-container *ngIf="submitted && hasErrors('dob', entry, ['date', 'maxDate'])">
                    <span *ngIf="hasErrors('dob', entry, ['date']); else maxDate" class="invalid-feedback">
                      Please enter a valid date.
                    </span>
                    <ng-template #maxDate>
                      <span class="invalid-feedback">
                        Date of birth must be today or in the past.
                      </span>
                    </ng-template>
                  </ng-container>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <app-fa-link icon="times" class="float-left" (click)="removeFamilyMember(i)">
                Remove
              </app-fa-link>
              <app-fa-link icon="plus-circle" color="#669900" class="float-right" (click)="addFamilyMember()">
                Add another contact
              </app-fa-link>
            </div>
          </div>
        </div>
      </div>
    </section>

    <h3 class="blue-header">PRIMARY RESIDENCE &amp; CONTACT DETAILS</h3>
    <section class="padded-section">
      <div class="d-flex flex-row">
        <p class="m-0 mr-4 required">Is your primary residence within BC</p>
        <div class="form-check form-check-inline">
          <input [class.is-invalid]="invalid('primaryResidenceInBC')" class="form-check-input" type="radio" formControlName="primaryResidenceInBC" [value]="true">
          <label class="form-check-label">Yes</label>
        </div>
        <div class="form-check form-check-inline">
          <input [class.is-invalid]="invalid('primaryResidenceInBC')" class="form-check-input" type="radio" formControlName="primaryResidenceInBC" [value]="false">
          <label class="form-check-label">No</label>
        </div>
      </div>
      <span [class.d-block]="invalid('primaryResidenceInBC')" class="invalid-feedback">
        {{validationErrors['primaryResidenceInBC']}}
      </span>
      <section *ngIf="ui.showPrimaryAddressSection()" class="mt-4 feature-block">
        <app-address-selector [parent]="primaryResidence" [touched]="submitted" [withinBC]="f['primaryResidenceInBC'].value">
        </app-address-selector>
        <section>
          <div class="row">
            <app-form-field class="col-md-6">
              <label>Telephone / Mobile Number</label>
              <input [class.is-invalid]="invalid('phoneNumber')" class="form-control" type="text" placeholder="" formControlName="phoneNumber">
              <small class="d-block" *ngIf="!!form.value.primaryResidenceInBC">(Format: 9999999999)</small>
              <span *ngIf="submitted" class="invalid-feedback">
                {{validationErrors['phoneNumber']}}
              </span>
            </app-form-field>
            <app-form-field class="col-md-6">
              <label>Alternate Telephone / Mobile Number</label>
              <input [class.is-invalid]="invalid('phoneNumberAlt')" class="form-control" type="text" placeholder="" formControlName="phoneNumberAlt">
              <small class="d-block" *ngIf="!!form.value.primaryResidenceInBC">(Format: 9999999999)</small>
              <span *ngIf="submitted" class="invalid-feedback">
                {{validationErrors['phoneNumberAlt']}}
              </span>
            </app-form-field>
          </div>
          <div class="row">
            <app-form-field class="col-md-8">
              <label>Email Address</label>
              <input [class.is-invalid]="invalid('email')" class="form-control" type="text" autocomplete="email" spellcheck="false" formControlName="email">
              <small>Your email address will be used to communicate with you about your registration.</small>
              <span *ngIf="submitted" class="invalid-feedback">
                {{validationErrors['email']}}
              </span>
            </app-form-field>
          </div>
        </section>
      </section>
    </section>

    <h3 class="blue-header">MAILING ADDRESS</h3>
    <section class="padded-section">
      <p class="required">Is your mailing address the same as your primary residence?</p>
      <div class="form-group">
        <div class="form-check">
          <input [class.is-invalid]="invalid('mailingAddressSameAsPrimary')" class="form-check-input" type="radio" formControlName="mailingAddressSameAsPrimary" [value]="true" (click)="nullMailingAddress()">
          <label class="form-check-label">Yes</label>
        </div>
        <div class="form-check">
          <input [class.is-invalid]="invalid('mailingAddressSameAsPrimary')" class="form-check-input" type="radio" formControlName="mailingAddressSameAsPrimary" [value]="false">
          <label class="form-check-label">No</label>
          <span *ngIf="submitted" class="invalid-feedback">
            {{validationErrors['mailingAddressSameAsPrimary']}}
          </span>
        </div>
      </div>
      <section *ngIf="ui.showMailingAddressSelector()" class="feature-block">
        <div class="d-flex flex-row">
          <p class="m-0 mr-4 required">Is your mailing address within BC</p>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" formControlName="mailingAddressInBC" [value]="true">
            <label class="form-check-label">Yes</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" formControlName="mailingAddressInBC" [value]="false">
            <label class="form-check-label">No</label>
          </div>
        </div>
        <span [class.d-block]="invalid('mailingAddressInBC')" class="invalid-feedback">
          {{validationErrors['mailingAddressInBC']}}
        </span>
        <app-address-selector class="mt-4" *ngIf="ui.showMailingAddressSection()" [parent]="mailingAddress" [touched]="submitted" [withinBC]="f['mailingAddressInBC'].value"></app-address-selector>
      </section>
    </section>

    <div *ngIf="errorSummary" class="mt-5 pl-5 text-danger">
      <app-font-awesome-icon icon="exclamation-triangle"></app-font-awesome-icon> {{ errorSummary }}
    </div>

    <div class="mt-5 space-between">
      <section>
        <a routerLink="/dashboard">
          <app-font-awesome-icon icon="times"></app-font-awesome-icon>
          <span class="ml-2">Cancel &amp; Close</span>
        </a>
      </section>
      <section>
        <button class="btn btn-primary" type="submit">NEXT</button>
      </section>
    </div>
  </div>
</form>
